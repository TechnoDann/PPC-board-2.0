<%# Expects the ID of the current post, if any, to be passed in `id`.
    `bodies` causes the bodies of the posts to be displayed when true.
    Pass a hash generated by `.arrange`. `subthread` is internal-use
    only.  %>
<% subthread ||= false %>
<% for post, subthreads in thread do %>
  <% if bodies && post.poofed %>
    <div class="poof-hider">
      <a href="#" style="font-weight: bold;" data-toggle="collapse" data-target="#thread-from-<%= post.id %>">
        This subthread is poofed. Click to show it.
      </a>
    </div>
  <% end %>

  <% if bodies && post.poofed %>
    <div id="thread-from-<%= post.id %>" class="collapse">
  <% end %>

  <% unless post.next_version %>
    <% unless subthread %>
      <ul class="thread row list-unstyled">
        <div class="col-md-12">
    <% end %>
    <li class="post post-in-thread" id="post-<%= post.id %>">
      <span class="<%= 'current-post' if post.id == id %>">
        <%= render :partial => 'post_subject', :object => post %>
      </span>
      <% if bodies && !(!subthread && post.id == id) %>
        <% unless post.next_version %>
          <%= link_to 'Reply', new_post_path(:parent_id => post) %>
          <% if allowed_to_edit? post, current_user %>
             | <%= link_to 'Edit', edit_post_path(post) %>
          <% end %>
        <% end %>
        <div class="post-body"><%= raw(markdown(post.body)) %></div>
        <span class="show-more-link"></span>
      <% elsif bodies && !subthread && post.id == id  %>
        <br /><br />
      <% end %>
    </li>
    <ul class="subthread list-unstyled">
      <%= render :partial => 'thread',
            :locals => { :bodies => bodies, :id => id, :subthread => true }, 
            :object => subthreads %>
    </ul> 

    <% unless subthread %>
        </div>
      </ul>
    <% end %>
    <% if bodies && post.poofed %></div> <% end %>
  <% end %>
<% end %>
